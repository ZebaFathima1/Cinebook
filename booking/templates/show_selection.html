{% extends 'base.html' %}
{% load static %}
{% load utils %}

<!-- Header -->
{% block title %}
        <title>Book a show</title>
        <link rel="stylesheet" href="{% static 'css/seat_selection2.css' %}">
        
        <style>
          .results{
            font-family: 'Lato', sans-serif;
          }
          .norounds{
            border-radius:0px;
          }
          .modal-content{
            background-color:black;
            color:white;
          }
          .sbodymodal{
            background-color:black;
          }
          .datebox{
            background-color:#000814;
            color:white;
            border-color:grey;
          }
        </style>
        
{% endblock title %}

<!-- Content -->
{% block content %}
<div class="container" id="movie-content">

  
    <div class="row">
        <h2 class="text-primary"  >Select Showtime</h2>
    </div>
    <div class="row">
        <form method="get" action="#" id="dateform">
            <div class="form-group row">
                <label for="selectdate" class="text-secondary col-sm-2 col-form-label">Select Date</label>
                <div class="col-sm-4">
                <input type="date"  name="date" class="form-control datebox"  value="{% if date %}{{ date }}{% else %}{{"%Y-%m-%d"|cdateadd:"1" }}{% endif %}"   min="{{ "%Y-%m-%d"|cdateadd:"1" }}" max="{{ "%Y-%m-%d"|cdateadd:"30" }}" id="selectdate" value="">
                </div>
                
            </div>
            <hr>
        </form>
    </div>
    <div class="row">
        <!-- results -->
        <div class="container col-md-8 results" >
          {% if date %}
          <p class="text-secondary">Movies showing on <b>{{ date }}</b> </p>
          {% else %}
          <p class="text-secondary">Please select a date to see available shows</p>
          {% endif %}
          
            {% if films %}
                {% for key, value in films.items %} 
                    <div class="row" style="margin-bottom: 20px; padding: 15px; background-color: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div class="col-md-2">
                          <img class="img-fluid "  style="margin:10px; border-radius: 5px;" src="{{value|get:"url"}}">
                        </div>
                        <div class="col-md-10">
                          <h1 style="color: #ffd60a;">{{ key }}</h1>
                          <div class="form-group">
                            {% for showid,time in value|get:"showtimes"|items %}
                              <button type="button" class="btn btn-success showtimebtn" style="padding:12px 30px; margin:8px; font-weight:bold; font-size:16px; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);" data-showid="{{ showid }}" data-price="{{ value|get:'price' }}" data-time="{{ time|tformat:'%I:%M %p' }}" title="Click to book seats for {{ time|tformat:'%I:%M %p' }}">
                                <i class="bi bi-ticket-perforated" style="font-size:18px;"></i> Book
                                <br><small style="display:block; font-size:0.75em; font-weight:normal; margin-top:3px;">{{ time|tformat:"%I:%M %p" }} | ${{ value|get:"price" }}</small>
                              </button>
                            {% endfor %}
                          </div>
                        </div>
                    </div>

                {% endfor %}
            {% elif date %}
              <div class="alert alert-warning" style="background-color: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #ffc107; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h4><i class="bi bi-info-circle"></i> No shows available</h4>
                <p>There are no movies showing on <strong>{{ date }}</strong>.</p>
                <div style="background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; margin: 15px 0;">
                  <p style="margin-bottom: 10px;"><strong>Important:</strong> For a show to appear on this date, it must have:</p>
                  <ul style="margin-left: 20px; margin-bottom: 0;">
                    <li><strong>Start Date</strong> ≤ <strong>{{ date }}</strong></li>
                    <li><strong>End Date</strong> ≥ <strong>{{ date }}</strong></li>
                    <li>Must be linked to a Movie</li>
                  </ul>
                </div>
                <p>Please try a different date or check your show dates in the admin panel.</p>
                {% if user.is_staff %}
                <a href="/admin/shows" class="btn btn-warning mt-2">
                  <i class="bi bi-plus-circle"></i> Add/Edit Shows (Admin)
                </a>
                <a href="/system/" class="btn btn-info mt-2 ml-2">
                  <i class="bi bi-gear"></i> Django Admin
                </a>
                {% endif %}
                
                {% if debug_info %}
                <div style="background-color: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-top: 20px; color: #fff;">
                  <h5 style="color: #ffd60a;">Debug Info (Admin Only):</h5>
                  <p>Recent shows in database:</p>
                  <table style="width: 100%; font-size: 12px;">
                    <tr style="border-bottom: 1px solid #555;">
                      <th style="padding: 5px; text-align: left;">Movie</th>
                      <th style="padding: 5px; text-align: left;">Start Date</th>
                      <th style="padding: 5px; text-align: left;">End Date</th>
                      <th style="padding: 5px; text-align: left;">In Range?</th>
                    </tr>
                    {% for info in debug_info %}
                    <tr style="border-bottom: 1px solid #333;">
                      <td style="padding: 5px;">{{ info.movie }}</td>
                      <td style="padding: 5px;">{{ info.start_date|default:"Not set" }}</td>
                      <td style="padding: 5px;">{{ info.end_date|default:"Not set" }}</td>
                      <td style="padding: 5px; color: {% if info.in_range %}#2ecc71{% else %}#e74c3c{% endif %};">
                        {% if info.in_range %}✓ Yes{% else %}✗ No{% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </table>
                </div>
                {% endif %}
              </div>
            {% else %}
              <div class="alert alert-info" style="background-color: rgba(13, 202, 240, 0.2); border: 1px solid #0dcaf0; color: #0dcaf0; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h4><i class="bi bi-calendar-event"></i> Select a Date</h4>
                <p>Please select a date above to see available movie shows and book tickets.</p>
              </div>
            {% endif %}
        </div>
       
    </div>


</div>
              <!-- Seat Booking -->
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg" role="document" style="max-width: 95%;">
                <div class="modal-content" >
                  <div class="modal-header" style="border-bottom: None;">
                    <h5 class="modal-title" id="exampleModalLongTitle">
                      <i class="bi bi-ticket-perforated"></i> Select Your Seats
                      <div id="show-info" style="font-size: 0.7em; color: #ffd60a; margin-top: 5px;"></div>
                    </h5>
                    <button type="button" style="color:white;" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" >
                    
                    <!-- Model body-->
                    <div class="sbodymodal" >
                      <div class="scontainer" style="max-width: 100%; padding: 15px;">
                        <!-- Screen -->
                        <div class="screen" style="margin-bottom: 25px;"></div>
                        <div style="text-align: center; color: #ffd60a; margin-bottom: 20px; font-weight: bold; font-size: 20px; letter-spacing: 3px;">SCREEN</div>
                        <hr style="border-color: #555; margin-bottom: 20px;">
                        
                        <!-- Seat Layout Container -->
                        <div style="overflow-x: auto; padding: 10px 0;">
                          <!-- Row Labels and Seats -->
                          <div style="display: flex; flex-direction: column; gap: 15px;">
                            
                            <!-- Row A -->
                            <div class="seat-row-wrapper">
                              <div class="srow" id="row-A">
                                <div class="seatindex-large">A</div>
                                <div class="seat-group"><div class="seat" sno="A1"></div><div class="seat" sno="A2"></div><div class="seat" sno="A3"></div><div class="seat" sno="A4"></div><div class="seat" sno="A5"></div><div class="seat" sno="A6"></div><div class="seat" sno="A7"></div><div class="seat" sno="A8"></div><div class="seat" sno="A9"></div><div class="seat" sno="A10"></div></div>
                                <div class="seat-group"><div class="seat" sno="A11"></div><div class="seat" sno="A12"></div><div class="seat" sno="A13"></div><div class="seat" sno="A14"></div><div class="seat" sno="A15"></div><div class="seat" sno="A16"></div><div class="seat" sno="A17"></div><div class="seat" sno="A18"></div><div class="seat" sno="A19"></div><div class="seat" sno="A20"></div></div>
                                <div class="seat-group"><div class="seat" sno="A21"></div><div class="seat" sno="A22"></div><div class="seat" sno="A23"></div><div class="seat" sno="A24"></div><div class="seat" sno="A25"></div><div class="seat" sno="A26"></div><div class="seat" sno="A27"></div><div class="seat" sno="A28"></div><div class="seat" sno="A29"></div><div class="seat" sno="A30"></div></div>
                              </div>
                            </div>
                            
                            <!-- Row B -->
                            <div class="seat-row-wrapper">
                              <div class="srow" id="row-B">
                                <div class="seatindex-large">B</div>
                                <div class="seat-group"><div class="seat" sno="B1"></div><div class="seat" sno="B2"></div><div class="seat" sno="B3"></div><div class="seat" sno="B4"></div><div class="seat" sno="B5"></div><div class="seat" sno="B6"></div><div class="seat" sno="B7"></div><div class="seat" sno="B8"></div><div class="seat" sno="B9"></div><div class="seat" sno="B10"></div></div>
                                <div class="seat-group"><div class="seat" sno="B11"></div><div class="seat" sno="B12"></div><div class="seat" sno="B13"></div><div class="seat" sno="B14"></div><div class="seat" sno="B15"></div><div class="seat" sno="B16"></div><div class="seat" sno="B17"></div><div class="seat" sno="B18"></div><div class="seat" sno="B19"></div><div class="seat" sno="B20"></div></div>
                                <div class="seat-group"><div class="seat" sno="B21"></div><div class="seat" sno="B22"></div><div class="seat" sno="B23"></div><div class="seat" sno="B24"></div><div class="seat" sno="B25"></div><div class="seat" sno="B26"></div><div class="seat" sno="B27"></div><div class="seat" sno="B28"></div><div class="seat" sno="B29"></div><div class="seat" sno="B30"></div></div>
                              </div>
                            </div>
                            
                            <!-- Row C -->
                            <div class="seat-row-wrapper">
                              <div class="srow" id="row-C">
                                <div class="seatindex-large">C</div>
                                <div class="seat-group"><div class="seat" sno="C1"></div><div class="seat" sno="C2"></div><div class="seat" sno="C3"></div><div class="seat" sno="C4"></div><div class="seat" sno="C5"></div><div class="seat" sno="C6"></div><div class="seat" sno="C7"></div><div class="seat" sno="C8"></div><div class="seat" sno="C9"></div><div class="seat" sno="C10"></div></div>
                                <div class="seat-group"><div class="seat" sno="C11"></div><div class="seat" sno="C12"></div><div class="seat" sno="C13"></div><div class="seat" sno="C14"></div><div class="seat" sno="C15"></div><div class="seat" sno="C16"></div><div class="seat" sno="C17"></div><div class="seat" sno="C18"></div><div class="seat" sno="C19"></div><div class="seat" sno="C20"></div></div>
                                <div class="seat-group"><div class="seat" sno="C21"></div><div class="seat" sno="C22"></div><div class="seat" sno="C23"></div><div class="seat" sno="C24"></div><div class="seat" sno="C25"></div><div class="seat" sno="C26"></div><div class="seat" sno="C27"></div><div class="seat" sno="C28"></div><div class="seat" sno="C29"></div><div class="seat" sno="C30"></div></div>
                              </div>
                            </div>
                            
                            <!-- Row D -->
                            <div class="seat-row-wrapper">
                              <div class="srow" id="row-D">
                                <div class="seatindex-large">D</div>
                                <div class="seat-group"><div class="seat" sno="D1"></div><div class="seat" sno="D2"></div><div class="seat" sno="D3"></div><div class="seat" sno="D4"></div><div class="seat" sno="D5"></div><div class="seat" sno="D6"></div><div class="seat" sno="D7"></div><div class="seat" sno="D8"></div><div class="seat" sno="D9"></div><div class="seat" sno="D10"></div></div>
                                <div class="seat-group"><div class="seat" sno="D11"></div><div class="seat" sno="D12"></div><div class="seat" sno="D13"></div><div class="seat" sno="D14"></div><div class="seat" sno="D15"></div><div class="seat" sno="D16"></div><div class="seat" sno="D17"></div><div class="seat" sno="D18"></div><div class="seat" sno="D19"></div><div class="seat" sno="D20"></div></div>
                                <div class="seat-group"><div class="seat" sno="D21"></div><div class="seat" sno="D22"></div><div class="seat" sno="D23"></div><div class="seat" sno="D24"></div><div class="seat" sno="D25"></div><div class="seat" sno="D26"></div><div class="seat" sno="D27"></div><div class="seat" sno="D28"></div><div class="seat" sno="D29"></div><div class="seat" sno="D30"></div></div>
                              </div>
                            </div>
                            
                            <!-- Seat Numbers Row -->
                            <div class="srow" style="margin-top: 15px;">
                              <div class="seatnumber" style="width: 30px;"></div>
                              <div class="seat-group"><div class="seatnumber">1</div><div class="seatnumber">2</div><div class="seatnumber">3</div><div class="seatnumber">4</div><div class="seatnumber">5</div><div class="seatnumber">6</div><div class="seatnumber">7</div><div class="seatnumber">8</div><div class="seatnumber">9</div><div class="seatnumber">10</div></div>
                              <div class="seat-group"><div class="seatnumber">11</div><div class="seatnumber">12</div><div class="seatnumber">13</div><div class="seatnumber">14</div><div class="seatnumber">15</div><div class="seatnumber">16</div><div class="seatnumber">17</div><div class="seatnumber">18</div><div class="seatnumber">19</div><div class="seatnumber">20</div></div>
                              <div class="seat-group"><div class="seatnumber">21</div><div class="seatnumber">22</div><div class="seatnumber">23</div><div class="seatnumber">24</div><div class="seatnumber">25</div><div class="seatnumber">26</div><div class="seatnumber">27</div><div class="seatnumber">28</div><div class="seatnumber">29</div><div class="seatnumber">30</div></div>
                            </div>
                            
                          </div>
                        </div>
                      </div>

                      <ul style="display: flex;  justify-content: space-between;  list-style-type: none;  background: rgba(0,0,0,0.1);  padding: 5px 10px;  border-radius: 5px;  color: #777;">
                        <li style="display: flex;  align-items: center;  justify-content: center;  margin: 0 10px;">
                          <div style="background-color: #fff;height: 12px;width: 15px;margin: 3px;border-top-left-radius: 10px;border-top-right-radius: 10px;"></div>
                          <small>Occupied</small>
                        </li>
                        <li style="display: flex;  align-items: center;  justify-content: center;  margin: 0 10px;">
                          <div style="background-color: #444451;height: 12px;width: 15px;margin: 3px;border-top-left-radius: 10px;border-top-right-radius: 10px;" ></div>
                          <small>Available</small>
                        </li>
                        <li style="display: flex;  align-items: center;  justify-content: center;  margin: 0 10px;">
                          <div style="background-color: #2ecc71;height: 12px;width: 15px;margin: 3px;border-top-left-radius: 10px;border-top-right-radius: 10px;" ></div>
                          <small>Selected</small>
                        </li>    
                      </ul>
                      
                      
                    </div>
                  </div>
                  <div class="modal-footer" style="border-top:None">
                    <div class="container-fluid">
                      <div class="row mb-3">
                        <div class="col-12">
                          <div id="booking-summary" style="background-color: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <h6 style="color: #ffd60a; margin-bottom: 10px;">Booking Summary</h6>
                            <p style="margin: 5px 0;"><strong>Selected Seats:</strong> <span id="selected-seats-display" style="color: #2ecc71;">None</span></p>
                            <p style="margin: 5px 0;"><strong>Number of Seats:</strong> <span id="seat-count" style="color: #2ecc71;">0</span></p>
                            <p style="margin: 5px 0;"><strong>Price per Seat:</strong> <span id="price-per-seat" style="color: #ffd60a;">$0</span></p>
                            <p style="margin: 5px 0; font-size: 18px;"><strong>Total Amount:</strong> <span id="total-amount" style="color: #2ecc71; font-weight: bold;">$0</span></p>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-12">
                          <form  id="target_form" method="post" action="/checkout">
                            {% csrf_token %}
                            <input type="hidden" type="text" name="showdate" id="show_date" value="{% if date %}{{ date }}{% endif %}" />
                            <input type="hidden" type="text" name="seats" id="seats_input" />
                            <input type="hidden" type="text" name="showid" id="show_id" />
                          </form>
                          <button type="button" class="btn btn-success btn-block bookticketsbtn" id="book-btn" disabled>
                            <i class="bi bi-check-circle"></i> Confirm & Book Tickets
                          </button>
                          <button type="button" class="btn btn-secondary btn-block mt-2" data-dismiss="modal">Cancel</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        <!-- End of Modal-->
{% endblock content %}

<!-- JS -->
{% block js%}

<script >
  $( document ).ready(function() {
    // update movies based on 
    
    
    $("#selectdate").change(function() {
        console.log($(this).val());
        console.log("date changed");
        $("#dateform").submit();
    });

    $(".showtimebtn").on('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      
      console.log("Book button clicked!");
      
      var show_id = $(this).attr("data-showid");
      var show_date = $("#show_date").val();
      
      if(!show_id) {
        console.error("No show ID found!");
        alert("Error: Show ID not found. Please try again.");
        return false;
      }
      
      console.log("Show ID:", show_id);
      console.log("Show Date:", show_date);
      
      // Set form values
      $("#show_id").val(show_id);
      
      // Get price and time from the button
      var price = $(this).attr("data-price") || 0;
      var time = $(this).attr("data-time") || "";
      var movieName = $(this).closest('.row').find('h1').text() || "";
      
      // Update modal title with show info
      if($("#show-info").length) {
        $("#show-info").html("<strong>" + movieName + "</strong> - " + time + " | $" + price + " per seat");
      }
      
      if($("#price-per-seat").length) {
        $("#price-per-seat").text("$" + price);
      }
      
      // Clear booked seats info
      $(".seat.occupied").removeClass("occupied");
      // clear selected seat info
      $(".seat.selected").removeClass("selected");
      
      // Reset booking summary
      if(typeof updateBookingSummary === 'function') {
        updateBookingSummary();
      }
      
      // Check if modal exists
      var modal = $('#exampleModalCenter');
      if(modal.length === 0) {
        console.error("Modal not found!");
        alert("Error: Seat selection modal not found. Please refresh the page.");
        return false;
      }
      
      console.log("Opening modal...");
      
      // Try Bootstrap modal method first
      try {
        modal.modal('show');
      } catch(err) {
        console.error("Bootstrap modal error:", err);
      }
      
      // Fallback: Force show modal if Bootstrap doesn't work
      setTimeout(function() {
        if(!modal.hasClass('show') || modal.css('display') === 'none') {
          console.log("Using fallback method to show modal...");
          modal.addClass('show');
          modal.css({
            'display': 'block',
            'padding-right': '17px'
          });
          $('body').addClass('modal-open');
          // Remove existing backdrop
          $('.modal-backdrop').remove();
          // Add backdrop
          $('<div class="modal-backdrop fade show"></div>').appendTo('body');
        }
      }, 50);
      
      // Load booked seats via AJAX after modal is shown
      modal.on('shown.bs.modal', function() {
        console.log("Modal is now shown, loading booked seats...");
        
        $.ajax({
          type:"GET", 
          url: "bookedseats", 
          data:{ show_id: show_id, show_date: show_date},
          success: function(data) {
            console.log("Booked seats data:", data);
            if(data && data.length != 0 && data.trim() !== ""){
              var booked = data.split(",");
              console.log("Booked seats:", booked);
              for (var i = 0; i < booked.length; i++){
                if(booked[i] && booked[i].trim() !== ""){
                  $(".seat[sno='" + booked[i].trim() + "']").addClass("occupied");
                }
              }
            } else {
              console.log("No booked seats");
            }
          },
          error: function(xhr, status, error) {
            console.error("Error loading booked seats:", error);
          }
        });
      });
      
      return false;
    });
    

    $(".seat").click(function (){
      if (!$(this).hasClass("occupied")){
        //if ($(this).hasClass("selected")){
        console.log($(this).attr("sno"));
        $(this).toggleClass("selected"); //toggles selected class
        seats();
      }
    });


    function seats(){
      // updates seats input field with selected seats
      var selected=[];
       $(".seat").each(function( index ) {
        if ($(this).hasClass("selected")){
          selected.push($(this).attr("sno"));
        }
      });
      console.log(selected);
      $("#seats_input").val(selected.join(","));
      updateBookingSummary();
      return selected;
    }

    function updateBookingSummary(){
      var selected = seats();
      var seatCount = selected.length;
      var pricePerSeat = parseFloat($("#price-per-seat").text().replace("$", "")) || 0;
      var total = seatCount * pricePerSeat;
      
      // Update display
      if(selected.length > 0){
        $("#selected-seats-display").text(selected.join(", "));
      } else {
        $("#selected-seats-display").text("None");
      }
      
      $("#seat-count").text(seatCount);
      $("#total-amount").text("$" + total.toFixed(2));
      
      // Enable/disable book button
      if(seatCount > 0){
        $("#book-btn").prop("disabled", false).removeClass("btn-secondary").addClass("btn-success");
      } else {
        $("#book-btn").prop("disabled", true).removeClass("btn-success").addClass("btn-secondary");
      }
    }

    $(".bookticketsbtn").click(function(e){
      e.preventDefault();
      e.stopPropagation();
      
      var selectedSeats = $("#seats_input").val();
      var showDate = $("#show_date").val();
      var showId = $("#show_id").val();
      
      console.log("Book button clicked");
      console.log("Selected seats:", selectedSeats);
      console.log("Show date:", showDate);
      console.log("Show ID:", showId);
      
      if(!selectedSeats || selectedSeats.length === 0){
        alert("Please select at least one seat to continue.");
        return false;
      }
      
      if(!showDate || !showId){
        alert("Missing show information. Please try again.");
        return false;
      }
      
      if(confirm("Confirm booking for seats: " + selectedSeats + "?")){
        // Close modal first
        $('#exampleModalCenter').modal('hide');
        
        // Submit form
        console.log("Submitting form to /checkout");
        $( "#target_form" ).submit();
      }
      
      return false;
    });
    
    

    $("#clearselected").click(function(){
      //clear all selected seats
    });
});
</script>
{% endblock js%}