{% extends 'base.html' %}
{% load static %}
{% load utils %}

{% block title %}
<title>My Bookings</title>
<style>
  .results {
    font-family: 'Lato', sans-serif;
  }
  .norounds {
    border-radius: 0px;
  }
  table {
    text-align: center;
  }
  .tab {
    background-color: black !important;
    border: None !important;
  }
</style>
{% endblock title %}

{% block content %}

<div class="container" id="movie-content">

  {% if msg %}
  <div class="alert alert-success alert-dismissible fade show" id="messageblk" role="alert">
    <strong>Success!</strong> {{ msg }}
    <button type="button" class="btn-close messagealert" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <div class="row">
    <h2 class="text-primary">My Bookings</h2>
  </div>

  {% if data %}
  <div class="table-responsive">
    <table class="table table-dark table-hover tab">
      <thead>
        <tr>
          <th></th>
          <th>Show Date</th>
          <th>Movie</th>
          <th>Show Time</th>
          <th>Seats</th>
          <th>Total</th>
          <th>Booking Code</th>
          <th>Booked</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody>
        {% for row in data %}
        <tr>
          <td class="tab">
            <img src="{{ row.show__movie__url }}" style="height:50px;width:40px;border-radius:5px;">
          </td>

          <td class="tab">{{ row.show_date }}</td>

          <td class="tab"><strong>{{ row.show__movie__movie_name }}</strong></td>

          <td class="tab">{{ row.show__showtime|tformat:"%I:%M %p" }}</td>

          <td class="tab text-success fw-bold">{{ row.seat_num }}</td>

          <td class="tab text-warning fw-bold">${{ row.total }}</td>

          <td class="tab">
            {% if row.booking_code %}
              <code style="background-color: rgba(255,255,255,0.2);padding:5px 10px;border-radius:5px;color:#ffd60a;font-weight:bold;">
                {{ row.booking_code }}
              </code>
            {% else %}
              <span class="text-secondary">N/A</span>
            {% endif %}
          </td>

          <td class="tab">{{ row.booked_date|tdiff }}</td>

          <td class="tab">
            <button type="button" class="btn bstatusbtn" data-id="{{ row.id }}">
              {{ row.show_date|bstatus }}
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <!-- Empty state -->
  <div class="alert alert-info text-center mt-4">
    <h4>No bookings found</h4>
    <p class="text-secondary">You haven't made any bookings yet. Start booking your favorite movie!</p>
    <a class="btn btn-primary" href="{% url 'show select' %}?date={{ "%Y-%m-%d"|cdateadd:"1" }}">
      Book a Show
    </a>
  </div>
  {% endif %}

</div>

<!-- Cancel Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bgdark">

      <div class="modal-header" style="border-bottom:none;">
        <h5 class="modal-title">Cancel booking?</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>

      <div class="modal-body">
        Are you sure you want to cancel this booking?
      </div>

      <div class="modal-footer" style="border-top:none;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <a href="#" class="btn btn-danger" id="finalConfirm">Confirm</a>
      </div>

    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script>
$(document).ready(function () {

  $(".bstatusbtn").each(function () {
    let val = $(this).text();
    if (val.includes("Cancel")) {
      $(this).addClass("btn btn-danger");
    } else if (val.includes("watched")) {
      $(this).removeClass("bstatusbtn");
    }
  });

  $(".bstatusbtn").click(function () {
    let val = $(this).text();
    if (val.includes("Cancel")) {
      let bid = $(this).attr("data-id");
      $("#finalConfirm").attr("href", "/cancel/" + bid + "/");
      $("#exampleModalCenter").modal("show");
    }
  });

  $(".messagealert").click(function () {
    $("#messageblk").hide();
  });

});
</script>
{% endblock %}
